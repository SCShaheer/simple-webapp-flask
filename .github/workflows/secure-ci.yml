name: Secure CI (SAST + SCA + Secrets + Container Scan + SBOM)

on:
  push:
    branches: ["**"]
  pull_request:

# CI-only: keep permissions minimal
permissions:
  contents: read

concurrency:
  group: secure-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secure-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install bandit pip-audit

      - name: Basic Python sanity checks
        run: |
          python -m compileall .

      - name: SAST (Bandit)
        run: |
          # Always produce a report (do not fail here)
          bandit -r . -x "./.venv,./venv,./.git,./.github" -f json -o bandit.json --exit-zero
          # Security gate: fail only on HIGH severity findings
          bandit -r . -x "./.venv,./venv,./.git,./.github" -iii

      - name: SCA (pip-audit)
        run: |
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt -f json -o pip-audit.json
          else
            echo "No requirements.txt found; skipping pip-audit."
          fi

      - name: Secrets scanning (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: "--verbose --redact --report-format json --report-path gitleaks.json"

      - name: Build Docker image
        run: |
          docker build -t local/simple-webapp-flask:${{ github.sha }} .

      - name: Container image scan (Trivy)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: local/simple-webapp-flask:${{ github.sha }}
          format: json
          output: trivy-image.json
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Generate SBOM (Anchore SBOM Action)
        uses: anchore/sbom-action@v0
        with:
          image: local/simple-webapp-flask:${{ github.sha }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            bandit.json
            pip-audit.json
            gitleaks.json
            trivy-image.json
            sbom.spdx.json
          if-no-files-found: warn
